#!/usr/bin/env python3
"""ghpr — CLI for the GitHub PR Monitor."""

import argparse
import json
import os
import shutil
import subprocess
import sys

# Resolve symlinks so this works when invoked via /usr/local/bin/ghpr
APP_DIR = os.path.dirname(os.path.realpath(__file__))
PLIST_NAME = "com.githubprcount.plist"
PLIST_PATH = os.path.expanduser(f"~/Library/LaunchAgents/{PLIST_NAME}")
VENV_DIR = os.path.join(APP_DIR, "venv")
CONFIG_PATH = os.path.join(APP_DIR, "config.json")
STATE_PATH = os.path.join(APP_DIR, "state.json")
BIN_LINK = "/usr/local/bin/ghpr"


def ensure_venv():
    if not os.path.isdir(VENV_DIR):
        print("Error: venv not found. Run install.sh first.")
        sys.exit(1)


def load_config():
    if not os.path.isfile(CONFIG_PATH):
        return {"repos": [], "poll_interval_seconds": 300}
    with open(CONFIG_PATH) as f:
        return json.load(f)


def save_config(config):
    with open(CONFIG_PATH, "w") as f:
        json.dump(config, f, indent=2)
        f.write("\n")


# ── start ────────────────────────────────────────────────────────────────────

def cmd_start(args):
    """Start the menu bar app in the foreground."""
    ensure_venv()

    # Ensure Homebrew binaries (including gh) are on PATH
    os.environ["PATH"] = f"/opt/homebrew/bin:/usr/local/bin:{os.environ.get('PATH', '')}"

    python = os.path.join(VENV_DIR, "bin", "python")
    script = os.path.join(APP_DIR, "gh_pr_menu.py")
    os.chdir(APP_DIR)
    os.execv(python, [python, script])


# ── uninstall ────────────────────────────────────────────────────────────────

def cmd_uninstall(args):
    """Full cleanup: LaunchAgent, symlink, and ~/.ghpr directory."""
    # 1. Stop and remove LaunchAgent
    if os.path.isfile(PLIST_PATH):
        print("Stopping and removing LaunchAgent...")
        subprocess.run(["launchctl", "unload", PLIST_PATH], capture_output=True)
        os.remove(PLIST_PATH)
    else:
        print("LaunchAgent not found — skipping.")

    # 2. Remove /usr/local/bin/ghpr symlink
    if os.path.islink(BIN_LINK):
        print(f"Removing {BIN_LINK}...")
        try:
            os.remove(BIN_LINK)
        except PermissionError:
            subprocess.run(["sudo", "rm", BIN_LINK], check=True)
    elif os.path.isfile(BIN_LINK):
        print(f"Removing {BIN_LINK}...")
        try:
            os.remove(BIN_LINK)
        except PermissionError:
            subprocess.run(["sudo", "rm", BIN_LINK], check=True)

    # 3. Delete ~/.ghpr directory (with confirmation)
    ghpr_dir = os.path.expanduser("~/.ghpr")
    if os.path.isdir(ghpr_dir):
        if sys.stdout.isatty():
            try:
                answer = input(f"\nDelete {ghpr_dir}? This removes all app data. [y/N] ").strip().lower()
            except (EOFError, KeyboardInterrupt):
                print("\nSkipping directory removal.")
                answer = ""
            if answer == "y":
                shutil.rmtree(ghpr_dir)
                print(f"Removed {ghpr_dir}")
            else:
                print(f"Kept {ghpr_dir}")
        else:
            shutil.rmtree(ghpr_dir)
            print(f"Removed {ghpr_dir}")

    print("\nGitHub PR Monitor uninstalled.")


# ── status ───────────────────────────────────────────────────────────────────

def cmd_status(args):
    """Show whether the daemon is running and current config."""
    # Check LaunchAgent
    result = subprocess.run(["launchctl", "list"], capture_output=True, text=True)
    is_loaded = "com.githubprcount" in result.stdout

    if is_loaded:
        # Extract PID from launchctl list output
        for line in result.stdout.splitlines():
            if "com.githubprcount" in line:
                parts = line.split()
                pid = parts[0] if parts[0] != "-" else None
                print(f"LaunchAgent: loaded (PID: {pid})" if pid else "LaunchAgent: loaded (not currently running)")
                break
    else:
        print("LaunchAgent: not installed")

    # Config summary
    if os.path.isfile(CONFIG_PATH):
        with open(CONFIG_PATH) as f:
            config = json.load(f)
        repos = config.get("repos", [])
        interval = config.get("poll_interval_seconds", "?")
        print(f"\nConfig: {CONFIG_PATH}")
        print(f"  Poll interval: {interval}s")
        print(f"  Repos ({len(repos)}):")
        for repo in repos:
            print(f"    - {repo}")
    else:
        print("\nNo config.json found. Run install.sh first.")

    # State summary
    if os.path.isfile(STATE_PATH):
        with open(STATE_PATH) as f:
            state = json.load(f)
        seen = len(state.get("seen_urls", []))
        print(f"\n  Tracked PRs (seen): {seen}")


# ── config ───────────────────────────────────────────────────────────────────

def cmd_config(args):
    """Manage config: list, add, remove repos, or open in $EDITOR."""
    sub = args.config_args

    if not sub:
        # No subcommand: open in $EDITOR or print
        if not os.path.isfile(CONFIG_PATH):
            sys.exit("No config.json found. Run install.sh first.")
        editor = os.environ.get("EDITOR")
        if editor and sys.stdout.isatty():
            os.execvp(editor, [editor, CONFIG_PATH])
        else:
            with open(CONFIG_PATH) as f:
                print(f.read(), end="")
        return

    action = sub[0]

    if action == "list":
        config = load_config()
        repos = config.get("repos", [])
        if not repos:
            print("No repos configured. Add one with: ghpr config add owner/repo")
        else:
            for repo in repos:
                print(repo)

    elif action == "add":
        if len(sub) < 2:
            sys.exit("Usage: ghpr config add owner/repo")
        repo = sub[1]
        if "/" not in repo:
            sys.exit("Invalid format — use owner/repo (e.g., octocat/Hello-World)")
        config = load_config()
        repos = config.get("repos", [])
        if repo in repos:
            print(f"Already monitoring {repo}")
        else:
            repos.append(repo)
            config["repos"] = repos
            save_config(config)
            print(f"Added {repo} ({len(repos)} repo(s) total)")

    elif action == "remove":
        if len(sub) < 2:
            sys.exit("Usage: ghpr config remove owner/repo")
        repo = sub[1]
        config = load_config()
        repos = config.get("repos", [])
        if repo not in repos:
            sys.exit(f"Not monitoring {repo}")
        repos.remove(repo)
        config["repos"] = repos
        save_config(config)
        print(f"Removed {repo} ({len(repos)} repo(s) remaining)")

    else:
        sys.exit(f"Unknown config subcommand: {action}\nUsage: ghpr config [list | add owner/repo | remove owner/repo]")


# ── restart ──────────────────────────────────────────────────────────────────

def cmd_restart(args):
    """Unload and reload the LaunchAgent."""
    if not os.path.isfile(PLIST_PATH):
        sys.exit("LaunchAgent not installed. Run install.sh first.")

    print("Restarting GitHub PR Monitor...")
    subprocess.run(["launchctl", "unload", PLIST_PATH], capture_output=True)
    subprocess.run(["launchctl", "load", PLIST_PATH], check=True)
    print("Restarted.")


# ── main ─────────────────────────────────────────────────────────────────────

def main():
    parser = argparse.ArgumentParser(
        prog="ghpr",
        description="GitHub PR Monitor — menu bar app for tracking pull requests",
    )
    sub = parser.add_subparsers(dest="command", required=True)

    sub.add_parser("start", help="Start the menu bar app in the foreground")
    sub.add_parser("uninstall", help="Full cleanup (LaunchAgent + symlink + ~/.ghpr)")
    sub.add_parser("status", help="Show daemon status and current config")
    sub.add_parser("restart", help="Restart the LaunchAgent")

    config_parser = sub.add_parser("config", help="Manage monitored repos (list, add, remove) or open config in $EDITOR")
    config_parser.add_argument("config_args", nargs="*", default=[], help="Subcommand: list, add owner/repo, remove owner/repo")

    args = parser.parse_args()

    commands = {
        "start": cmd_start,
        "uninstall": cmd_uninstall,
        "status": cmd_status,
        "config": cmd_config,
        "restart": cmd_restart,
    }
    commands[args.command](args)


if __name__ == "__main__":
    main()
